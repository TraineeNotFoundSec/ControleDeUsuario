unit UnitPrincipal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  FireDAC.Phys.FBDef, FireDAC.Stan.Intf, FireDAC.Phys, FireDAC.Phys.IBBase,
  FireDAC.Phys.FB, FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf,
  FireDAC.Phys.Intf, FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async,
  FireDAC.Phys.PG, FireDAC.Phys.PGDef, FireDAC.VCLUI.Wait, Data.DB,
  FireDAC.Comp.Client, FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf,
  FireDAC.DApt, FireDAC.Comp.DataSet, Vcl.DBCGrids, Vcl.Grids, Vcl.DBGrids;

type
  TForm1 = class(TForm)
    GroupBox1: TGroupBox;
    txtUsuario: TEdit;
    txtSenha: TEdit;
    btnEntrar: TButton;
    btnNovoAcesso: TButton;
    btnRecuperar: TButton;
    Panel1: TPanel;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    FDConnection1: TFDConnection;
    FDQuery1: TFDQuery;
    Edit1: TEdit;
    Edit2: TEdit;
    Edit3: TEdit;
    DBGrid1: TDBGrid;
    DataSource1: TDataSource;
    FDQuery2: TFDQuery;
    Edit4: TEdit;
    Edit5: TEdit;
    Edit6: TEdit;
    Edit7: TEdit;
    Button1: TButton;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Button2: TButton;
    Button3: TButton;
    procedure btnEntrarClick(Sender: TObject);
    procedure btnNovoAcessoClick(Sender: TObject);
    procedure btnRecuperarClick(Sender: TObject);
    procedure DBGrid1DblClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;


// -----------------------------------------------------------------------------

var
  Form1: TForm1;
  validador: boolean;

implementation

{$R *.dfm}

procedure ClearPanelData(Panel: TPanel);
var
  I: Integer;
  begin
    for I := 0 to Panel.ControlCount - 1 do
      begin
        if Panel.Controls[I] is TEdit then
          TEdit(Panel.Controls[I]).Text := '' // Limpa o texto dos Edit
        else if Panel.Controls[I] is TMemo then
          TMemo(Panel.Controls[I]).Lines.Clear // Limpa o conteúdo dos Memo
        else if Panel.Controls[I] is TComboBox then
          TComboBox(Panel.Controls[I]).ItemIndex := -1; // Reseta a seleção do ComboBox
        // Adicione mais condições conforme necessário para outros componentes
      end;
  end;

// ------------------------------ btnEntrar ------------------------------

procedure TForm1.btnEntrarClick(Sender: TObject);
var
  query: string;
  query1: string;

begin
  if (not validador) then
    begin

    btnRecuperar.Caption := 'Recuperar';

    Panel3.Visible := False;
    Panel4.Visible := False;

    ClearPanelData(Panel3);
    ClearPanelData(Panel4);

      if (txtUsuario.Text = '') or (txtSenha.Text = '') then
        begin
          ShowMessage('Preencha os campos Usuário e Senha');
          Exit;
        end;

      query := 'SELECT * FROM users WHERE users.user = ''' + txtUsuario.Text + ''' AND users.password = ''' + txtSenha.Text + '''';
      query1 := 'SELECT users.id_user AS "ID", users.name AS "Nome", users.email AS "E-Mail", users.user AS "Usuário", CASE WHEN users.user = ''' + txtUsuario.Text + ''' THEN True ELSE NULL END AS "Logado" FROM users ORDER BY id_user ASC';


      try
        FDConnection1.Connected := True;                // Abre a conexão

        FDQuery1.SQL.Text := query;                     // Estrutura a consulta
        FDQuery1.Open;                                  // Realiza a consulta
        FDQuery2.SQL.Text := query1;                     // Estrutura a consulta
        FDQuery2.Open;                                  // Realiza a consulta

        validador := FDQuery1.Fields[0].AsInteger > 0;  // Obtem o primeiro campo da consulta

        if validador then
          begin

            txtSenha.Text := '';
            btnEntrar.Caption := 'Sair';

            Panel2.Visible := True;
            Panel3.Visible := False;
            Panel4.Visible := False;

            ClearPanelData(Panel2);
            ClearPanelData(Panel3);
            ClearPanelData(Panel4);

            ShowMessage('Bem-Vindo(a), ' + FDQuery1.Fields[1].AsString + '.');
          end

        else
          begin
            Panel2.Visible := False;
            Panel3.Visible := False;
            Panel4.Visible := False;

            ShowMessage('Usuário ou senha incorretos');
          end;

      finally
      end;
    end

  else
    begin
      validador := False;

      btnEntrar.Caption := 'Entrar';
      btnNovoAcesso.Caption := 'Criar';
      btnRecuperar.Caption := 'Recuperar';

      Panel2.Visible := False;
      Panel3.Visible := False;
      Panel4.Visible := False;

      ClearPanelData(Panel2);
      ClearPanelData(Panel3);
      ClearPanelData(Panel4);

      txtUsuario.Text := txtUsuario.Text;
      txtSenha.Text := '';

      ShowMessage('Volte sempre, ' + FDQuery1.Fields[1].AsString + '.');
      FDConnection1.Connected := False;
    end;
end;

// ------------------------------ btnNovoAcesso ------------------------------

procedure TForm1.btnNovoAcessoClick(Sender: TObject);
begin
  if validador then
    begin
      if Panel2.Visible then
        begin
        Panel2.Visible := False;
        Panel3.Visible := True;
        Panel4.Visible := False;

        ClearPanelData(Panel2);
        ClearPanelData(Panel3);
        ClearPanelData(Panel4);

        btnEntrar.Caption := 'Sair';
        btnNovoAcesso.Caption := 'Listar';
        btnRecuperar.Caption := 'Recuperar';
      end

      else if Panel4.Visible then
        begin
        Panel2.Visible := False;
        Panel3.Visible := True;
        Panel4.Visible := False;

        ClearPanelData(Panel2);
        ClearPanelData(Panel3);
        ClearPanelData(Panel4);

        btnEntrar.Caption := 'Sair';
        btnNovoAcesso.Caption := 'Listar';
        btnRecuperar.Caption := 'Recuperar';
      end

      else
        begin
          Panel2.Visible := True;
          Panel3.Visible := False;
          Panel4.Visible := False;

          ClearPanelData(Panel2);
          ClearPanelData(Panel3);
          ClearPanelData(Panel4);

          btnEntrar.Caption := 'Sair';
          btnNovoAcesso.Caption := 'Criar';
          btnRecuperar.Caption := 'Recuperar';
        end;
  end

  else
    begin
      ShowMessage('Você precisa estar logado para criar novos usuários');
      Panel2.Visible := False;
      Panel3.Visible := False;
      Panel4.Visible := Panel4.Visible;

      ClearPanelData(Panel2);
      ClearPanelData(Panel3);

      if not Panel4.Visible then
        begin
          ClearPanelData(Panel4);
          btnRecuperar.Caption := 'Recuperar';
        end;

      btnEntrar.Caption := 'Entrar';
      btnNovoAcesso.Caption := 'Criar';
    end;

end;

// ------------------------------ btnRecuperar -------------------------------

procedure TForm1.btnRecuperarClick(Sender: TObject);
begin
  Panel2.Visible := False;
  Panel3.Visible := False;
  Panel4.Visible := not Panel4.Visible;

  ClearPanelData(Panel2);
  ClearPanelData(Panel3);
  ClearPanelData(Panel4);

  btnNovoAcesso.Caption := 'Criar';

  if Panel4.Visible then
    begin
      btnRecuperar.Caption := 'Fechar';
    end

  else
    begin
      btnRecuperar.Caption := 'Recuperar';
    end;

  if validador then
    begin
      Panel2.Visible := not Panel4.Visible;
    end;

end;

procedure TForm1.DBGrid1DblClick(Sender: TObject);
begin
  Panel2.Visible := False;
  Panel3.Visible := True;
  Panel4.Visible := False;

  ClearPanelData(Panel2);
  ClearPanelData(Panel3);
  ClearPanelData(Panel4);

  Edit2.Text := FDQuery2.FieldByName('ID').AsString;
  Edit4.Text := FDQuery2.FieldByName('Nome').AsString;
  Edit5.Text := FDQuery2.FieldByName('E-Mail').AsString;
  Edit6.Text := FDQuery2.FieldByName('Usuário').AsString;
  Edit7.Text := '*****';

  btnNovoAcesso.Caption := 'Listar';
end;

end.
